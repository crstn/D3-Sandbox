<!DOCTYPE html>
<meta charset="utf-8">
<style>

.country:hover{
  stroke: darkgrey;
}

</style>

<body>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

var transferByCountry = d3.map();
var refugeesFromCountry = d3.map();

// we'll set the domain and range once we have loaded the csv
var scale = d3.scale.linear();

// Map width and height
var width = 1100,
    height = 700;

//Define map projection
var projection = d3.geo.mercator()
  .rotate([0,0])   // [lon,lat]
  .center([70,40]) // [lon,lat]
  .translate([width/2, height/2])
  .precision(0.1)
  .scale([400]);

//Define path generator
var path = d3.geo.path()
  .projection(projection);

var svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height);

queue()
  .defer(d3.json, "world.json")
  .defer(d3.csv, "iati.csv", function(d) { 
        transferByCountry.set(d.country, +d.usd); })
  .defer(d3.csv, "refugees.csv", function(d) { 
        refugeesFromCountry.set(d.fromCode, d.toCode, +d.refugees); })
  .await(ready);

function ready(error, world) {

  // now that we have loaded the iati csv, we can dynamically set 
  // the domain and range for the scale
  // depending on the min and max values of the dataset
  scale.domain([d3.min(d3.values(transferByCountry)), 0, d3.max(d3.values(transferByCountry))])
    .range(["red", "grey", "green"]);

  // show the unhcr data
//  svg.append("g")
//      .attr("class", "refugees")
//      .selectAll("path")
//      .data(refugeesFromCountry, function(d) {
//        d.fromCode;
//      })
//      .enter()
//      .append("path");

  // show the iati data
	svg.append("g")
    	.attr("class", "countries")
    	.selectAll("path")
      	.data(topojson.feature(world, world.objects.countries).features)
    	.enter()
    	.append("path")
    	.attr("fill", function(d) {         

    		if(transferByCountry.get(d.id) == undefined){
    			return "rgb(222,222,222)"; // countries without values are grey
    		} else {
          return scale(transferByCountry.get(d.id));
    		}      		 
    	})
      .attr("class", "country")
    	.attr("d", path)
      .append("svg:title")
      .text(function(d) {

        if(transferByCountry.get(d.id) == undefined){
          return d.id+": No data for 2012"; // countries without values are grey
        } else {
          return d.id+": "+transferByCountry.get(d.id)+" USD";
        }
      });
}

</script>